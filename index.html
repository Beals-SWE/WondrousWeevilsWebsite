<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weevil Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        nav h1 {
            color: #667eea;
            font-size: 1.8rem;
        }

        nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        nav button:hover {
            background: #764ba2;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Map Page Styles */
        #map-page {
            display: block;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .map-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .map-image {
            width: 100%;
            height: auto;
            border-radius: 10px;
            display: block;
        }

        .map-icon {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ff6b6b;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .map-icon:hover:not(.locked) {
            transform: scale(1.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .map-icon.revealed {
            background: #51cf66;
        }

        .map-icon.locked {
            background: #868e96;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .map-icon.dragging {
            z-index: 1000;
            cursor: move;
        }

        .weevil-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .weevil-popup.active {
            display: block;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .popup-overlay.active {
            display: block;
        }

        .weevil-popup img {
            width: 100%;
            max-width: 300px;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .weevil-popup h2 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .weevil-popup button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.7rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 1rem;
        }

        .weevil-popup button:hover {
            background: #764ba2;
        }

        .weevil-popup .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .weevil-popup .add-collection-btn {
            background: #51cf66;
        }

        .weevil-popup .add-collection-btn:hover {
            background: #40c057;
        }

        /* Collection Page Styles */
        #collection-page {
            display: none;
        }

        .week-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .week-section h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .weevil-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .weevil-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 3px solid transparent;
        }

        .weevil-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .weevil-card.collected {
            border-color: #51cf66;
            background: #d3f9d8;
        }

        .weevil-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .weevil-card .weevil-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 0.3rem;
        }

        .weevil-card .status {
            font-size: 0.9rem;
            color: #868e96;
        }

        .weevil-card.collected .status {
            color: #51cf66;
            font-weight: bold;
        }

        .download-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .weevil-card:hover .download-icon {
            opacity: 1;
        }

        .download-icon:hover {
            background: #764ba2;
        }

        .weevil-card {
            position: relative;
        }

        .top-five-section {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
        }

        .top-five-section.viewing-shared {
            background: linear-gradient(135deg, #74c0fc 0%, #4dabf7 100%);
        }

        .shared-banner {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            border: 2px solid #4dabf7;
        }

        .shared-banner h3 {
            color: #4dabf7;
            margin-bottom: 0.5rem;
        }

        .shared-banner button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

        .shared-banner button:hover {
            background: #764ba2;
        }

        .top-five-section h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.8rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .collapse-toggle {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #fab005;
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: normal;
            transition: all 0.3s;
        }

        .collapse-toggle:hover {
            background: white;
            transform: scale(1.05);
        }

        .top-five-section h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.8rem;
            text-align: center;
        }

        .top-five-section .instructions {
            background: rgba(255, 255, 255, 0.9);
            border-left-color: #fab005;
            margin-bottom: 1.5rem;
        }

        .top-five-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1.5rem;
            transition: all 0.3s;
        }

        .top-five-section.collapsed-partial .top-five-grid {
            max-height: 250px;
            overflow: hidden;
        }

        .top-five-section.collapsed-full .top-five-grid {
            display: none;
        }

        .top-five-section.collapsed-full .instructions,
        .top-five-section.collapsed-full .top-twenty-actions {
            display: none;
        }

        @media (max-width: 1200px) {
            .top-five-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 900px) {
            .top-five-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .top-five-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .top-five-slot {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 3px dashed #fab005;
            cursor: grab;
            transition: all 0.3s;
        }

        .top-five-slot:active {
            cursor: grabbing;
        }

        .top-five-slot.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .top-five-slot.drag-over {
            border-color: #667eea;
            border-style: solid;
            background: rgba(102, 126, 234, 0.1);
        }

        .top-five-slot:hover {
            background: white;
            border-style: solid;
        }

        .top-five-slot.filled {
            border-style: solid;
            border-color: #fab005;
            background: white;
        }

        .top-five-slot img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .top-five-slot .slot-number {
            font-size: 2rem;
            color: #fab005;
            margin-bottom: 0.5rem;
        }

        .top-five-slot .empty-text {
            color: #868e96;
            font-size: 0.9rem;
        }

        .top-five-slot .weevil-name {
            font-weight: bold;
            color: #333;
        }

        .top-five-slot .remove-btn {
            margin-top: 0.5rem;
            padding: 0.3rem 0.8rem;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .top-twenty-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .top-twenty-actions button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .top-twenty-actions button:hover {
            background: #764ba2;
        }

        .top-twenty-actions button.secondary {
            background: #868e96;
        }

        .top-twenty-actions button.secondary:hover {
            background: #495057;
        }

        .selector-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .selector-modal.active {
            display: block;
        }

        .selector-modal h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        .selector-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .selector-card:hover {
            border-color: #667eea;
            transform: translateY(-3px);
        }

        .selector-card img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 0.3rem;
        }

        .selector-card .weevil-name {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .selector-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .selector-overlay.active {
            display: block;
        }

        .year-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .year-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }

        .year-header h2 {
            color: white;
            margin: 0;
            font-size: 1.8rem;
        }

        .year-toggle {
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .year-section.collapsed .year-toggle {
            transform: rotate(-90deg);
        }

        .year-section.collapsed .year-content {
            display: none;
        }

        .week-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 1rem;
            padding: 0.5rem;
        }

        .week-header:hover {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 5px;
        }

        .week-header h3 {
            color: #667eea;
            margin: 0;
            font-size: 1.3rem;
        }

        .week-toggle {
            font-size: 1.2rem;
            color: #667eea;
            transition: transform 0.3s;
        }

        .week-section.collapsed .week-toggle {
            transform: rotate(-90deg);
        }

        .week-section.collapsed .weevil-grid {
            display: none;
        }

        .calendar-filter {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .calendar-filter button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .calendar-filter button:hover {
            background: #764ba2;
        }

        .filter-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .filter-modal.active {
            display: block;
        }

        .filter-modal h3 {
            color: #667eea;
            margin-bottom: 1rem;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .filter-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
        }

        .filter-checkbox:hover {
            background: #f8f9fa;
        }

        .filter-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .filter-actions button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-actions .apply-btn {
            background: #667eea;
            color: white;
        }

        .filter-actions .cancel-btn {
            background: #868e96;
            color: white;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .edit-mode-toggle {
            background: #ffd43b;
            color: #333;
            padding: 0.7rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .edit-mode-toggle.active {
            background: #51cf66;
        }

        .coordinates-display {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            display: none;
        }

        .coordinates-display.active {
            display: block;
        }

        .reset-button {
            background: #ff6b6b;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .reset-button:hover {
            background: #ff5252;
        }

        .reset-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            z-index: 1001;
            text-align: center;
            max-width: 400px;
        }

        .reset-popup.active {
            display: block;
        }

        .reset-popup.step2 {
            max-width: 360px;
            padding: 1.8rem;
        }

        .reset-popup.step3 {
            max-width: 320px;
            padding: 1.5rem;
        }

        .reset-popup p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: #333;
            line-height: 1.5;
        }

        .reset-popup button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 0.7rem 2rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
        }

        .reset-popup button:hover {
            background: #ff5252;
        }

        .reset-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .reset-overlay.active {
            display: block;
        }

        footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            margin-top: 3rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .footer-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
        }

        .footer-section {
            text-align: center;
        }

        .footer-section h3 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .footer-section p {
            color: #333;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .footer-section a {
            color: #667eea;
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: color 0.3s;
        }

        .footer-section a:hover {
            color: #764ba2;
        }

        @media (max-width: 768px) {
            .footer-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            nav {
                flex-direction: column;
                gap: 1rem;
            }

            .weevil-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <nav>
        <h1>üêõ Weevil Collection</h1>
        <div>
            <button id="nav-map" onclick="showPage('map')">Map</button>
            <button id="nav-collection" onclick="showPage('collection')">My Collection</button>
        </div>
    </nav>

    <div class="container">
        <!-- Map Page -->
        <div id="map-page">
            <div class="instructions">
                <strong>üìç Click on an icon to discover this week's Weevil!</strong> Once revealed, other icons will lock for the week.
            </div>
            
            <button class="edit-mode-toggle" onclick="toggleEditMode()">üîß Toggle Edit Mode (Drag Icons)</button>
            
            <div class="coordinates-display" id="coordinates-display">
                Click "Copy Coordinates" after positioning your icons to save them for your code.
                <div id="coordinates-output" style="margin-top: 0.5rem;"></div>
                <button onclick="copyCoordinates()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; cursor: pointer;">üìã Copy Coordinates</button>
            </div>

            <div class="map-container">
                <div class="map-wrapper" id="map-wrapper">
                    <!-- Replace this placeholder with your actual map image -->
                    <img src="https://via.placeholder.com/800x600/e9ecef/667eea?text=Your+Map+Here" alt="Weevil Map" class="map-image" id="map-image">
                    
                    <!-- Map Icons will be generated here -->
                </div>
            </div>

            <div style="text-align: center;">
                <button class="reset-button" onclick="startReset()">Reset Selection</button>
            </div>
        </div>

        <!-- Collection Page -->
        <div id="collection-page">
            <div class="instructions">
                <strong>‚ú® Click on any Weevil to mark it as collected!</strong> Your collection is saved automatically.
            </div>

            <div class="calendar-filter">
                <span style="font-weight: bold;">üìÖ Filter Weeks:</span>
                <button onclick="openFilterModal()">Select Weeks to Display</button>
            </div>

            <!-- Top 5 Section -->
            <div class="top-five-section collapsed-partial" id="top-twenty-section">
                <div id="shared-banner-container"></div>
                <h2>
                    ‚≠ê Favorites ‚≠ê
                    <button class="collapse-toggle" onclick="toggleTopTwentyCollapse()">Show All</button>
                </h2>
                <div class="instructions">
                    <strong>Click a slot to select a Weevil. Drag to reorder!</strong>
                </div>
                <div class="top-five-grid" id="top-five-grid"></div>
                <div class="top-twenty-actions">
                    <button onclick="downloadTopTwenty()">üì• Download Favorites</button>
                    <button onclick="copyTopTwentyCode()">üìã Copy Code</button>
                    <button onclick="shareTopTwenty()">üîó Share Favorites</button>
                    <button onclick="importTopTwenty()" class="secondary">üì§ Import Code</button>
                </div>
            </div>

            <div id="collection-container"></div>
        </div>
    </div>

    <!-- Popup -->
    <div class="popup-overlay" id="popup-overlay"></div>
    <div class="weevil-popup" id="weevil-popup">
        <img id="popup-image" src="" alt="Weevil">
        <h2 id="popup-name"></h2>
        <p id="popup-description"></p>
        <div class="button-group">
            <button onclick="addToCollectionAndNavigate()">Add to my Collection</button>
            <button onclick="closePopup()">Close</button>
        </div>
    </div>

    <!-- Reset Popups -->
    <div class="reset-overlay" id="reset-overlay"></div>
    <div class="reset-popup" id="reset-popup-1">
        <p>Click this if you messed up and need to reset your Weekly Weevil map</p>
        <button onclick="showResetStep2()">Continue</button>
    </div>
    <div class="reset-popup step2" id="reset-popup-2">
        <p>Are you sure you need to? Or do you just want a different one</p>
        <button onclick="showResetStep3()">I'm sure</button>
    </div>
    <div class="reset-popup step3" id="reset-popup-3">
        <p>OK Last chance, Weevils know if you're lying</p>
        <button onclick="confirmReset()">Reset My Selection</button>
    </div>

    <!-- Top 5 Selector Modal -->
    <div class="selector-overlay" id="selector-overlay"></div>
    <div class="selector-modal" id="selector-modal">
        <h3>Select a Weevil for this slot</h3>
        <div class="selector-grid" id="selector-grid"></div>
    </div>

    <!-- Filter Modal -->
    <div class="selector-overlay" id="filter-overlay"></div>
    <div class="filter-modal" id="filter-modal">
        <h3>üìÖ Select Weeks to Display</h3>
        <div id="filter-content"></div>
        <div class="filter-actions">
            <button class="apply-btn" onclick="applyFilters()">Apply</button>
            <button class="cancel-btn" onclick="closeFilterModal()">Cancel</button>
        </div>
    </div>

    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h3>Section 1 Title</h3>
                <p>Add your text here</p>
                <a href="#">Link 1</a>
                <a href="#">Link 2</a>
            </div>
            <div class="footer-section">
                <h3>Section 2 Title</h3>
                <p>Add your text here</p>
                <a href="#">Link 1</a>
                <a href="#">Link 2</a>
            </div>
            <div class="footer-section">
                <h3>Section 3 Title</h3>
                <p>Add your text here</p>
                <a href="#">Link 1</a>
                <a href="#">Link 2</a>
            </div>
        </div>
    </footer>

    <script>
        // LZString compression library (inline for simplicity)
        // Minified version of LZString for URL compression
        var LZString=function(){var r=String.fromCharCode,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",e={};function t(r,o){if(!e[r]){e[r]={};for(var n=0;n<r.length;n++)e[r][r.charAt(n)]=n}return e[r][o]}var i={compressToBase64:function(r){if(null==r)return"";var n=i._compress(r,6,function(r){return o.charAt(r)});switch(n.length%4){default:case 0:return n;case 1:return n+"===";case 2:return n+"==";case 3:return n+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:i._decompress(r.length,32,function(n){return t(o,r.charAt(n))})},compressToUTF16:function(o){return null==o?"":i._compress(o,15,function(o){return r(o+32)})+" "},decompressFromUTF16:function(r){return null==r?"":""==r?null:i._decompress(r.length,16384,function(o){return r.charCodeAt(o)-32})},compressToUint8Array:function(r){for(var o=i.compress(r),n=new Uint8Array(2*o.length),e=0,t=o.length;e<t;e++){var s=o.charCodeAt(e);n[2*e]=s>>>8,n[2*e+1]=s%256}return n},decompressFromUint8Array:function(o){if(null==o)return i.decompress(o);for(var n=new Array(o.length/2),e=0,t=n.length;e<t;e++)n[e]=256*o[2*e]+o[2*e+1];var s=[];return n.forEach(function(o){s.push(r(o))}),i.decompress(s.join(""))},compressToEncodedURIComponent:function(r){return null==r?"":i._compress(r,6,function(r){return n.charAt(r)})},decompressFromEncodedURIComponent:function(r){return null==r?"":""==r?null:(r=r.replace(/ /g,"+"),i._decompress(r.length,32,function(o){return t(n,r.charAt(o))}))},compress:function(o){return i._compress(o,16,function(o){return r(o)})},_compress:function(r,o,n){if(null==r)return"";var e,t,i,s={},u={},a="",p="",c="",l=2,f=3,h=2,d=[],m=0,v=0;for(i=0;i<r.length;i+=1)if(a=r.charAt(i),Object.prototype.hasOwnProperty.call(s,a)||(s[a]=f++,u[a]=!0),p=c+a,Object.prototype.hasOwnProperty.call(s,p))c=p;else{if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++),s[p]=f++,c=String(a)}if(""!==c){if(Object.prototype.hasOwnProperty.call(u,c)){if(c.charCodeAt(0)<256){for(e=0;e<h;e++)m<<=1,v==o-1?(v=0,d.push(n(m)),m=0):v++;for(t=c.charCodeAt(0),e=0;e<8;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}else{for(t=1,e=0;e<h;e++)m=m<<1|t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t=0;for(t=c.charCodeAt(0),e=0;e<16;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1}0==--l&&(l=Math.pow(2,h),h++),delete u[c]}else for(t=s[c],e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;0==--l&&(l=Math.pow(2,h),h++)}for(t=2,e=0;e<h;e++)m=m<<1|1&t,v==o-1?(v=0,d.push(n(m)),m=0):v++,t>>=1;for(;;){if(m<<=1,v==o-1){d.push(n(m));break}v++}return d.join("")},decompress:function(r){return null==r?"":""==r?null:i._decompress(r.length,32768,function(o){return r.charCodeAt(o)})},_decompress:function(o,n,e){var t,i,s,u,a,p,c,l=[],f=4,h=4,d=3,m="",v=[],g={val:e(0),position:n,index:1};for(t=0;t<3;t+=1)l[t]=t;for(s=0,a=Math.pow(2,2),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;c=r(s);break;case 2:return""}for(l[3]=c,i=c,v.push(c);;){if(g.index>o)return"";for(s=0,a=Math.pow(2,d),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;switch(c=s){case 0:for(s=0,a=Math.pow(2,8),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 1:for(s=0,a=Math.pow(2,16),p=1;p!=a;)u=g.val&g.position,g.position>>=1,0==g.position&&(g.position=n,g.val=e(g.index++)),s|=(u>0?1:0)*p,p<<=1;l[h++]=r(s),c=h-1,f--;break;case 2:return v.join("")}if(0==f&&(f=Math.pow(2,d),d++),l[c])m=l[c];else{if(c!==h)return null;m=i+i.charAt(0)}v.push(m),l[h++]=i+m.charAt(0),i=m,0==--f&&(f=Math.pow(2,d),d++)}}};return i}();"function"==typeof define&&define.amd?define(function(){return LZString}):"undefined"!=typeof module&&null!=module&&(module.exports=LZString);

        // ========== CONFIGURATION SECTION - EDIT THIS ==========
        
        // WEEVIL DATA - Edit this to add your Weevils
        // IMPORTANT: The 'filename' field is used as the unique identifier for matching
        // Use the exact filename without extension (e.g., "2026_W01_GenericColoredWeevil")
        // Weeks are organized by year and will display newest first
        const weevils = {
            2026: {
                "W02": [
                    { 
                        name: "Sky Weevil", 
                        description: "Soars through clouds", 
                        image: "https://via.placeholder.com/300/74c0fc/ffffff?text=Sky+Weevil",
                        filename: "2026_W02_SkyWeevil"
                    },
                    { 
                        name: "Desert Weevil", 
                        description: "Survives in sand", 
                        image: "https://via.placeholder.com/300/ffd43b/ffffff?text=Desert+Weevil",
                        filename: "2026_W02_DesertWeevil"
                    },
                    { 
                        name: "Ice Weevil", 
                        description: "Thrives in snow", 
                        image: "https://via.placeholder.com/300/a5d8ff/ffffff?text=Ice+Weevil",
                        filename: "2026_W02_IceWeevil"
                    }
                ],
                "W01": [
                    { 
                        name: "Leafy Weevil", 
                        description: "Found in forest areas", 
                        image: "https://via.placeholder.com/300/51cf66/ffffff?text=Leafy+Weevil",
                        filename: "2026_W01_LeafyWeevil"
                    },
                    { 
                        name: "Fire Weevil", 
                        description: "Lives near volcanoes", 
                        image: "https://via.placeholder.com/300/ff6b6b/ffffff?text=Fire+Weevil",
                        filename: "2026_W01_FireWeevil"
                    },
                    { 
                        name: "Water Weevil", 
                        description: "Swims in rivers", 
                        image: "https://via.placeholder.com/300/4dabf7/ffffff?text=Water+Weevil",
                        filename: "2026_W01_WaterWeevil"
                    },
                    { 
                        name: "Rock Weevil", 
                        description: "Hides in caves", 
                        image: "https://via.placeholder.com/300/868e96/ffffff?text=Rock+Weevil",
                        filename: "2026_W01_RockWeevil"
                    }
                ]
            }
        };

        // CURRENT WEEK - Change this each week (format: year and week, e.g., 2026, "W02")
        const CURRENT_YEAR = 2026;
        const CURRENT_WEEK = "W02";

        // MAP ICON POSITIONS - Coordinates are percentages (0-100) of the map image
        // After using edit mode, copy the output and paste it here
        const iconPositions = [
            { top: 20, left: 30 },  // Icon 1
            { top: 45, left: 60 },  // Icon 2
            { top: 70, left: 25 },  // Icon 3
            { top: 35, left: 75 }   // Icon 4
        ];

        // ========== END CONFIGURATION SECTION ==========

        let editMode = false;
        let draggedIcon = null;
        let currentWeekKey = `selected_${CURRENT_YEAR}_${CURRENT_WEEK}`;
        let currentRevealedWeevil = null; // Track the currently revealed Weevil
        let draggedSlotIndex = null; // For Top 20 dragging
        let viewingSharedCollection = false; // Track if viewing a shared collection
        let sharedTopTwenty = null; // Store shared collection data
        let collapseState = 'partial'; // 'partial', 'expanded', 'full' - default to showing top 5
        let weekFilters = {}; // Track which weeks to display

        // Load saved data
        let collection = {};
        let weeklySelections = {};
        let topFive = [];
        try {
            const savedCollection = localStorage.getItem('weevilCollection');
            const savedSelections = localStorage.getItem('weevilWeeklySelections');
            const savedTopFive = localStorage.getItem('weevilTopFive');
            const savedFilters = localStorage.getItem('weevilWeekFilters');
            if (savedCollection) collection = JSON.parse(savedCollection);
            if (savedSelections) weeklySelections = JSON.parse(savedSelections);
            if (savedTopFive) topFive = JSON.parse(savedTopFive);
            if (savedFilters) weekFilters = JSON.parse(savedFilters);
        } catch (e) {
            console.error('Could not load saved data');
        }

        // Initialize filters with all weeks visible by default
        function initializeFilters() {
            let hasFilters = false;
            Object.keys(weevils).forEach(year => {
                Object.keys(weevils[year]).forEach(week => {
                    const key = `${year}_${week}`;
                    if (weekFilters[key] === undefined) {
                        weekFilters[key] = true;
                    } else {
                        hasFilters = true;
                    }
                });
            });
            if (!hasFilters) saveData();
        }

        initializeFilters();

        // Check if user has already selected a Weevil this week
        function hasSelectedThisWeek() {
            return weeklySelections[currentWeekKey] !== undefined;
        }

        // Save data
        function saveData() {
            try {
                localStorage.setItem('weevilCollection', JSON.stringify(collection));
                localStorage.setItem('weevilWeeklySelections', JSON.stringify(weeklySelections));
                localStorage.setItem('weevilTopFive', JSON.stringify(topFive));
                localStorage.setItem('weevilWeekFilters', JSON.stringify(weekFilters));
            } catch (e) {
                console.error('Could not save data');
            }
        }

        // Initialize map icons
        function initializeMapIcons() {
            const wrapper = document.getElementById('map-wrapper');
            const existingIcons = wrapper.querySelectorAll('.map-icon');
            existingIcons.forEach(icon => icon.remove());

            const currentWeevils = weevils[CURRENT_YEAR][CURRENT_WEEK];
            const isLocked = hasSelectedThisWeek();

            currentWeevils.forEach((weevil, index) => {
                if (iconPositions[index]) {
                    const icon = document.createElement('div');
                    icon.className = 'map-icon';
                    icon.dataset.weevilIndex = index;
                    icon.style.top = iconPositions[index].top + '%';
                    icon.style.left = iconPositions[index].left + '%';
                    icon.innerHTML = 'üîç';

                    // Check if this specific icon was the one selected
                    if (isLocked && weeklySelections[currentWeekKey] === index) {
                        icon.classList.add('revealed');
                    } else if (isLocked) {
                        icon.classList.add('locked');
                    }

                    icon.addEventListener('click', handleIconClick);
                    
                    // Dragging functionality
                    icon.addEventListener('mousedown', startDrag);
                    icon.addEventListener('touchstart', startDrag);

                    wrapper.appendChild(icon);
                }
            });
        }

        // Handle icon click
        function handleIconClick(e) {
            if (editMode) return; // Don't trigger popup in edit mode
            
            const icon = e.currentTarget;
            
            if (icon.classList.contains('locked')) {
                alert('You\'ve already selected a Weevil this week!');
                return;
            }

            const weevilIndex = parseInt(icon.dataset.weevilIndex);
            const weevil = weevils[CURRENT_YEAR][CURRENT_WEEK][weevilIndex];
            
            // Mark this as the selected Weevil for the week
            weeklySelections[currentWeekKey] = weevilIndex;
            saveData();

            showPopup(weevil, CURRENT_YEAR, CURRENT_WEEK, weevilIndex);
            
            // Update all icons - reveal this one, lock others
            document.querySelectorAll('.map-icon').forEach(otherIcon => {
                if (otherIcon === icon) {
                    otherIcon.classList.add('revealed');
                } else {
                    otherIcon.classList.add('locked');
                }
            });
        }

        // Toggle edit mode
        function toggleEditMode() {
            editMode = !editMode;
            const button = document.querySelector('.edit-mode-toggle');
            const coordDisplay = document.getElementById('coordinates-display');
            
            if (editMode) {
                button.classList.add('active');
                button.textContent = '‚úì Edit Mode Active (Drag Icons)';
                coordDisplay.classList.add('active');
                updateCoordinatesDisplay();
            } else {
                button.classList.remove('active');
                button.textContent = 'üîß Toggle Edit Mode (Drag Icons)';
                coordDisplay.classList.remove('active');
            }
        }

        // Dragging functions
        function startDrag(e) {
            if (!editMode) return;
            
            e.preventDefault();
            draggedIcon = e.currentTarget;
            draggedIcon.classList.add('dragging');
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', drag);
            document.addEventListener('touchend', stopDrag);
        }

        function drag(e) {
            if (!draggedIcon) return;
            
            const mapWrapper = document.getElementById('map-wrapper');
            const rect = mapWrapper.getBoundingClientRect();
            
            let clientX, clientY;
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = ((clientX - rect.left) / rect.width) * 100;
            const y = ((clientY - rect.top) / rect.height) * 100;
            
            draggedIcon.style.left = Math.max(0, Math.min(100, x)) + '%';
            draggedIcon.style.top = Math.max(0, Math.min(100, y)) + '%';
        }

        function stopDrag() {
            if (draggedIcon) {
                draggedIcon.classList.remove('dragging');
                draggedIcon = null;
                updateCoordinatesDisplay();
            }
            
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('touchend', stopDrag);
        }

        // Update coordinates display
        function updateCoordinatesDisplay() {
            const icons = document.querySelectorAll('.map-icon');
            const coords = Array.from(icons).map(icon => {
                return {
                    top: Math.round(parseFloat(icon.style.top)),
                    left: Math.round(parseFloat(icon.style.left))
                };
            });
            
            const output = document.getElementById('coordinates-output');
            output.innerHTML = `<pre>const iconPositions = ${JSON.stringify(coords, null, 2)};</pre>`;
        }

        // Copy coordinates
        function copyCoordinates() {
            const icons = document.querySelectorAll('.map-icon');
            const coords = Array.from(icons).map(icon => {
                return {
                    top: Math.round(parseFloat(icon.style.top)),
                    left: Math.round(parseFloat(icon.style.left))
                };
            });
            
            const text = `const iconPositions = ${JSON.stringify(coords, null, 2)};`;
            navigator.clipboard.writeText(text).then(() => {
                alert('Coordinates copied to clipboard!');
            }).catch(() => {
                alert('Could not copy. Please manually copy from the display above.');
            });
        }

        // Show popup
        function showPopup(weevil, year, week, weevilIndex) {
            currentRevealedWeevil = { weevil };
            
            document.getElementById('popup-image').src = weevil.image;
            document.getElementById('popup-name').textContent = weevil.name;
            document.getElementById('popup-description').textContent = weevil.description;
            document.getElementById('popup-overlay').classList.add('active');
            document.getElementById('weevil-popup').classList.add('active');
        }

        // Close popup
        function closePopup() {
            document.getElementById('popup-overlay').classList.remove('active');
            document.getElementById('weevil-popup').classList.remove('active');
            currentRevealedWeevil = null;
        }

        // Add to collection and navigate
        function addToCollectionAndNavigate() {
            if (!currentRevealedWeevil) return;
            
            const { weevil } = currentRevealedWeevil;
            
            // Mark as collected using filename as the unique key
            collection[weevil.filename] = true;
            saveData();
            
            // Close popup
            closePopup();
            
            // Navigate to collection page
            showPage('collection');
        }

        document.getElementById('popup-overlay').addEventListener('click', closePopup);

        // Reset functionality
        function startReset() {
            document.getElementById('reset-overlay').classList.add('active');
            document.getElementById('reset-popup-1').classList.add('active');
        }

        function showResetStep2() {
            document.getElementById('reset-popup-1').classList.remove('active');
            document.getElementById('reset-popup-2').classList.add('active');
        }

        function showResetStep3() {
            document.getElementById('reset-popup-2').classList.remove('active');
            document.getElementById('reset-popup-3').classList.add('active');
        }

        function confirmReset() {
            // Clear the weekly selection
            delete weeklySelections[currentWeekKey];
            saveData();
            
            // Close all popups
            closeResetPopups();
            
            // Reinitialize the map icons
            initializeMapIcons();
            
            alert('Your weekly selection has been reset!');
        }

        function closeResetPopups() {
            document.getElementById('reset-overlay').classList.remove('active');
            document.getElementById('reset-popup-1').classList.remove('active');
            document.getElementById('reset-popup-2').classList.remove('active');
            document.getElementById('reset-popup-3').classList.remove('active');
        }

        // Close reset popups when clicking overlay
        document.getElementById('reset-overlay').addEventListener('click', closeResetPopups);

        // Download Weevil image
        function downloadWeevil(weevil) {
            // Create a temporary link to download the image
            const link = document.createElement('a');
            link.href = weevil.image;
            link.download = `${weevil.filename}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Top 5 functionality
        let currentTopFiveSlot = null;

        function renderTopFive() {
            const grid = document.getElementById('top-five-grid');
            grid.innerHTML = '';

            // Determine which data to display
            const displayData = viewingSharedCollection ? sharedTopTwenty : topFive;
            const totalSlots = 20;

            for (let i = 0; i < totalSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'top-five-slot';
                slot.draggable = !viewingSharedCollection; // Only draggable if not viewing shared
                slot.dataset.slotIndex = i;
                
                if (displayData[i]) {
                    // Find the weevil by filename
                    let foundWeevil = null;
                    Object.keys(weevils).forEach(weekKey => {
                        const weevil = weevils[weekKey].find(w => w.filename === displayData[i].filename);
                        if (weevil) foundWeevil = weevil;
                    });

                    if (foundWeevil) {
                        slot.classList.add('filled');
                        slot.innerHTML = `
                            <img src="${foundWeevil.image}" alt="${foundWeevil.name}">
                            <div class="weevil-name">${foundWeevil.name}</div>
                            ${!viewingSharedCollection ? `<button class="remove-btn" onclick="removeFromTopFive(${i}); event.stopPropagation();">Remove</button>` : ''}
                        `;
                    } else {
                        // Weevil not found, show empty slot
                        slot.innerHTML = `
                            <div class="slot-number">#${i + 1}</div>
                            <div class="empty-text">Click to select</div>
                        `;
                    }
                } else {
                    slot.innerHTML = `
                        <div class="slot-number">#${i + 1}</div>
                        <div class="empty-text">${viewingSharedCollection ? 'Empty' : 'Click to select'}</div>
                    `;
                }

                // Add event listeners only if not viewing shared
                if (!viewingSharedCollection) {
                    slot.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('remove-btn')) {
                            openTopFiveSelector(i);
                        }
                    });
                    
                    // Drag and drop events
                    slot.addEventListener('dragstart', handleDragStart);
                    slot.addEventListener('dragover', handleDragOver);
                    slot.addEventListener('drop', handleDrop);
                    slot.addEventListener('dragend', handleDragEnd);
                    slot.addEventListener('dragleave', handleDragLeave);
                }

                grid.appendChild(slot);
            }

            // Update banner if viewing shared
            updateSharedBanner();
        }

        // Drag and drop handlers for Top 20
        function handleDragStart(e) {
            if (viewingSharedCollection) return;
            draggedSlotIndex = parseInt(e.target.dataset.slotIndex);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (viewingSharedCollection) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const slot = e.currentTarget;
            if (!slot.classList.contains('dragging')) {
                slot.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (viewingSharedCollection) return;
            e.preventDefault();
            e.stopPropagation();
            
            const targetSlotIndex = parseInt(e.currentTarget.dataset.slotIndex);
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedSlotIndex !== targetSlotIndex) {
                // Swap the two slots
                const temp = topFive[draggedSlotIndex];
                topFive[draggedSlotIndex] = topFive[targetSlotIndex];
                topFive[targetSlotIndex] = temp;
                saveData();
                renderTopFive();
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.top-five-slot').forEach(slot => {
                slot.classList.remove('drag-over');
            });
        }

        function openTopFiveSelector(slotIndex) {
            currentTopFiveSlot = slotIndex;
            const modal = document.getElementById('selector-modal');
            const overlay = document.getElementById('selector-overlay');
            const selectorGrid = document.getElementById('selector-grid');
            
            selectorGrid.innerHTML = '';

            // Get all collected Weevils
            Object.keys(weevils).forEach(year => {
                Object.keys(weevils[year]).forEach(week => {
                    weevils[year][week].forEach((weevil) => {
                        if (collection[weevil.filename]) {
                            const card = document.createElement('div');
                            card.className = 'selector-card';
                            card.innerHTML = `
                                <img src="${weevil.image}" alt="${weevil.name}">
                                <div class="weevil-name">${weevil.name}</div>
                            `;
                            card.addEventListener('click', () => selectForTopFive(weevil));
                            selectorGrid.appendChild(card);
                        }
                    });
                });
            });

            if (selectorGrid.children.length === 0) {
                selectorGrid.innerHTML = '<p style="text-align: center; color: #868e96;">No collected Weevils yet! Mark some as collected first.</p>';
            }

            overlay.classList.add('active');
            modal.classList.add('active');
        }

        function selectForTopFive(weevil) {
            topFive[currentTopFiveSlot] = { filename: weevil.filename };
            saveData();
            closeTopFiveSelector();
            renderTopFive();
        }

        function removeFromTopFive(slotIndex) {
            topFive[slotIndex] = null;
            saveData();
            renderTopFive();
        }

        function closeTopFiveSelector() {
            document.getElementById('selector-overlay').classList.remove('active');
            document.getElementById('selector-modal').classList.remove('active');
        }

        document.getElementById('selector-overlay').addEventListener('click', closeTopFiveSelector);

        // Top 20 Export/Import/Share functionality
        function getTopTwentyData() {
            // Filter out null/undefined values and only include filenames
            return topFive.filter(item => item && item.filename).map(item => item.filename);
        }

        function downloadTopTwenty() {
            const data = getTopTwentyData();
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            
            // Create a text file with the code
            const blob = new Blob([compressed], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'my-favorite-weevils.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('Your Favorites have been downloaded! Keep this file safe to restore your collection later.');
        }

        function copyTopTwentyCode() {
            const data = getTopTwentyData();
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            
            navigator.clipboard.writeText(compressed).then(() => {
                alert('Code copied to clipboard! You can paste this code to restore your Favorites later.');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = compressed;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Code copied to clipboard! You can paste this code to restore your Favorites later.');
            });
        }

        function shareTopTwenty() {
            const data = getTopTwentyData();
            const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(data));
            const url = window.location.origin + window.location.pathname + '#shared=' + compressed;
            
            navigator.clipboard.writeText(url).then(() => {
                alert('Share link copied to clipboard! Send this link to show off your Favorites.');
            }).catch(() => {
                // Fallback
                prompt('Copy this link to share your Favorites:', url);
            });
        }

        function importTopTwenty() {
            const code = prompt('Paste your Favorites code here:');
            if (!code) return;
            
            try {
                const decompressed = LZString.decompressFromEncodedURIComponent(code);
                const data = JSON.parse(decompressed);
                
                // Validate data is an array of strings
                if (!Array.isArray(data) || !data.every(item => typeof item === 'string')) {
                    throw new Error('Invalid data format');
                }
                
                // Convert filenames back to objects
                topFive = data.map(filename => ({ filename }));
                
                // Pad with nulls to make 20 slots
                while (topFive.length < 20) {
                    topFive.push(null);
                }
                
                saveData();
                renderTopFive();
                alert('Your Favorites have been restored!');
            } catch (e) {
                alert('Invalid code. Please check and try again.');
                console.error('Import error:', e);
            }
        }

        function updateSharedBanner() {
            const bannerContainer = document.getElementById('shared-banner-container');
            const section = document.getElementById('top-twenty-section');
            
            if (viewingSharedCollection) {
                section.classList.add('viewing-shared');
                bannerContainer.innerHTML = `
                    <div class="shared-banner">
                        <h3>üëÄ Viewing a Shared Collection</h3>
                        <p>This is someone else's Favorites. Your collection is safe!</p>
                        <button onclick="returnToMyCollection()">üè† Back to My Collection</button>
                        <button onclick="copySharedCollection()">üìã Copy These Favorites</button>
                    </div>
                `;
            } else {
                section.classList.remove('viewing-shared');
                bannerContainer.innerHTML = '';
            }
        }

        function returnToMyCollection() {
            viewingSharedCollection = false;
            sharedTopTwenty = null;
            window.history.pushState({}, '', window.location.pathname);
            renderTopFive();
        }

        function copySharedCollection() {
            if (!confirm('This will replace your current Favorites with this shared collection. Are you sure?')) {
                return;
            }
            
            topFive = [...sharedTopTwenty];
            saveData();
            viewingSharedCollection = false;
            sharedTopTwenty = null;
            window.history.pushState({}, '', window.location.pathname);
            renderTopFive();
            alert('Favorites copied to your collection!');
        }

        function toggleTopTwentyCollapse() {
            const section = document.getElementById('top-twenty-section');
            const button = document.querySelector('.collapse-toggle');
            
            if (collapseState === 'partial') {
                // Expand to show all 20
                collapseState = 'expanded';
                section.classList.remove('collapsed-partial', 'collapsed-full');
                button.textContent = 'Hide';
            } else if (collapseState === 'expanded') {
                // Collapse fully (hide everything)
                collapseState = 'full';
                section.classList.add('collapsed-full');
                section.classList.remove('collapsed-partial');
                button.textContent = 'Show';
            } else {
                // Back to showing top 5
                collapseState = 'partial';
                section.classList.add('collapsed-partial');
                section.classList.remove('collapsed-full');
                button.textContent = 'Show All';
            }
        }

        function loadSharedCollection() {
            const hash = window.location.hash;
            if (hash.startsWith('#shared=')) {
                const compressed = hash.substring(8);
                try {
                    const decompressed = LZString.decompressFromEncodedURIComponent(compressed);
                    const data = JSON.parse(decompressed);
                    
                    if (Array.isArray(data)) {
                        // Convert to Top 20 format
                        sharedTopTwenty = data.map(filename => ({ filename }));
                        while (sharedTopTwenty.length < 20) {
                            sharedTopTwenty.push(null);
                        }
                        viewingSharedCollection = true;
                        
                        // Navigate to collection page
                        showPage('collection');
                    }
                } catch (e) {
                    console.error('Failed to load shared collection:', e);
                    alert('Invalid share link. Returning to your collection.');
                    window.location.hash = '';
                }
            }
        }

        // Show page
        function showPage(page) {
            document.getElementById('map-page').style.display = page === 'map' ? 'block' : 'none';
            document.getElementById('collection-page').style.display = page === 'collection' ? 'block' : 'none';
            
            if (page === 'collection') {
                renderTopFive();
                renderCollection();
            }
        }

        // Render collection page
        function renderCollection() {
            const container = document.getElementById('collection-container');
            container.innerHTML = '';

            // Get years in descending order
            const years = Object.keys(weevils).sort((a, b) => b - a);

            years.forEach(year => {
                const yearSection = document.createElement('div');
                yearSection.className = 'year-section';
                yearSection.dataset.year = year;
                
                const yearHeader = document.createElement('div');
                yearHeader.className = 'year-header';
                yearHeader.innerHTML = `
                    <h2>${year}</h2>
                    <span class="year-toggle">‚ñº</span>
                `;
                yearHeader.addEventListener('click', () => toggleYear(year));
                yearSection.appendChild(yearHeader);

                const yearContent = document.createElement('div');
                yearContent.className = 'year-content';

                // Get weeks in descending order (W52, W51... W02, W01)
                const weeks = Object.keys(weevils[year]).sort((a, b) => {
                    const numA = parseInt(a.substring(1));
                    const numB = parseInt(b.substring(1));
                    return numB - numA;
                });

                weeks.forEach(week => {
                    const filterKey = `${year}_${week}`;
                    if (!weekFilters[filterKey]) return; // Skip if filtered out

                    const weekSection = document.createElement('div');
                    weekSection.className = 'week-section';
                    weekSection.dataset.week = week;
                    
                    const weekHeader = document.createElement('div');
                    weekHeader.className = 'week-header';
                    weekHeader.innerHTML = `
                        <h3>Week ${week.substring(1)} - ${year}</h3>
                        <span class="week-toggle">‚ñº</span>
                    `;
                    weekHeader.addEventListener('click', () => toggleWeek(year, week));
                    weekSection.appendChild(weekHeader);

                    const grid = document.createElement('div');
                    grid.className = 'weevil-grid';

                    weevils[year][week].forEach((weevil) => {
                        const card = document.createElement('div');
                        card.className = 'weevil-card';
                        
                        if (collection[weevil.filename]) {
                            card.classList.add('collected');
                        }

                        card.innerHTML = `
                            <img src="${weevil.image}" alt="${weevil.name}">
                            <div class="weevil-name">${weevil.name}</div>
                            <div class="status">${collection[weevil.filename] ? '‚úì Collected' : 'Not collected'}</div>
                            ${collection[weevil.filename] ? '<div class="download-icon" title="Download">‚¨áÔ∏è</div>' : ''}
                        `;

                        card.addEventListener('click', (e) => {
                            // Check if download icon was clicked
                            if (e.target.classList.contains('download-icon')) {
                                e.stopPropagation();
                                downloadWeevil(weevil);
                                return;
                            }

                            if (collection[weevil.filename]) {
                                delete collection[weevil.filename];
                            } else {
                                collection[weevil.filename] = true;
                            }
                            saveData();
                            renderCollection();
                            renderTopFive();
                        });

                        grid.appendChild(card);
                    });

                    weekSection.appendChild(grid);
                    yearContent.appendChild(weekSection);
                });

                yearSection.appendChild(yearContent);
                container.appendChild(yearSection);
            });
        }

        function toggleYear(year) {
            const section = document.querySelector(`.year-section[data-year="${year}"]`);
            section.classList.toggle('collapsed');
        }

        function toggleWeek(year, week) {
            const section = document.querySelector(`.year-section[data-year="${year}"] .week-section[data-week="${week}"]`);
            section.classList.toggle('collapsed');
        }

        // Filter modal functions
        function openFilterModal() {
            const modal = document.getElementById('filter-modal');
            const overlay = document.getElementById('filter-overlay');
            const content = document.getElementById('filter-content');
            
            content.innerHTML = '';

            // Get years in descending order
            const years = Object.keys(weevils).sort((a, b) => b - a);

            years.forEach(year => {
                const section = document.createElement('div');
                section.className = 'filter-section';
                
                const header = document.createElement('h4');
                header.textContent = year;
                section.appendChild(header);

                const checkboxes = document.createElement('div');
                checkboxes.className = 'filter-checkboxes';

                // Get weeks in descending order
                const weeks = Object.keys(weevils[year]).sort((a, b) => {
                    const numA = parseInt(a.substring(1));
                    const numB = parseInt(b.substring(1));
                    return numB - numA;
                });

                weeks.forEach(week => {
                    const filterKey = `${year}_${week}`;
                    const label = document.createElement('label');
                    label.className = 'filter-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = weekFilters[filterKey] !== false;
                    checkbox.dataset.filterKey = filterKey;
                    
                    const text = document.createElement('span');
                    text.textContent = `Week ${week.substring(1)}`;
                    
                    label.appendChild(checkbox);
                    label.appendChild(text);
                    checkboxes.appendChild(label);
                });

                section.appendChild(checkboxes);
                content.appendChild(section);
            });

            overlay.classList.add('active');
            modal.classList.add('active');
        }

        function closeFilterModal() {
            document.getElementById('filter-overlay').classList.remove('active');
            document.getElementById('filter-modal').classList.remove('active');
        }

        function applyFilters() {
            const checkboxes = document.querySelectorAll('#filter-content input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                weekFilters[checkbox.dataset.filterKey] = checkbox.checked;
            });
            
            saveData();
            closeFilterModal();
            renderCollection();
        }

        document.getElementById('filter-overlay').addEventListener('click', closeFilterModal);

        // Initialize
        loadSharedCollection(); // Check for shared collection in URL first
        initializeMapIcons();
        renderTopFive();
        renderCollection();
    </script>
</body>
</html>